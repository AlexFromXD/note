# BGP Overview

## ğŸ¯ æœ¬ç¯‡èƒ½è§£ç­”çš„é—œéµå•é¡Œ

- è‡ªæ²»ç³»çµ±ï¼ˆAutonomous Systemï¼‰æ˜¯èª°å®šç¾©çš„ï¼Ÿä»€éº¼æ™‚å€™ç®—æ˜¯ä¸€å€‹ç¨ç«‹ç¶²åŸŸï¼Ÿ
- ç‚ºä»€éº¼æ˜æ˜æœ‰ IP å’Œ TCPï¼Œé‚„éœ€è¦ BGPï¼Ÿ
- BGP æ˜¯æ€éº¼æ±ºå®šå°åŒ…çš„èµ°å‘ï¼Ÿæœƒæ±ºå®šæ•´æ¢è·¯å—ï¼Ÿ
- è¦æ€éº¼é–‹å§‹ç‡Ÿé‹è‡ªå·±çš„è‡ªæ²»ç³»çµ±ï¼Ÿå¯¦éš›è¦åšå“ªäº›äº‹ï¼Ÿåˆæ€éº¼é€éå®ƒç²åˆ©ï¼Ÿ

---

## ğŸ“– åè©è§£é‡‹

| åè©                                 | å®šç¾©                                                                       |
| ------------------------------------ | -------------------------------------------------------------------------- |
| **BGP**ï¼ˆBorder Gateway Protocolï¼‰   | ä¸€ç¨®ç¬¬ 4 å±¤å”å®šï¼Œè®“ä¸åŒè‡ªæ²»ç³»çµ±ä¹‹é–“äº¤æ›è·¯ç”±è³‡è¨Šã€‚                          |
| **ASN**ï¼ˆAutonomous System Numberï¼‰  | æ¯å€‹è‡ªæ²»ç³»çµ±çš„å”¯ä¸€è­˜åˆ¥ç·¨è™Ÿï¼Œå¯ç‚ºå…¬æœ‰æˆ–ç§æœ‰ã€‚                               |
| **Prefix**                           | ä¸€æ®µ IP ç¶²æ®µï¼Œä»¥ CIDR è¡¨ç¤ºï¼Œä¾‹å¦‚ `10.0.0.0/16`ã€‚BGP å®£å‘Šçš„æœ€å°å–®ä½ã€‚       |
| **BGP Session**ï¼ˆBGP é€£ç·šï¼‰          | BGP å°ç­‰ç«¯ä¹‹é–“çš„é€£ç·šï¼Œé€šå¸¸é€é TCP port 179 å»ºç«‹ï¼Œå»ºç«‹å¾Œæ‰èƒ½äº¤æ›è·¯ç”±è³‡è¨Šã€‚ |
| **Static Route**ï¼ˆéœæ…‹è·¯ç”±ï¼‰         | æ‰‹å‹•é…ç½®çš„è·¯ç”±ï¼Œä¸æœƒè‡ªå‹•æ›´æ–°ã€‚                                             |
| **IGP**ï¼ˆInterior Gateway Protocolï¼‰ | åœ¨å–®ä¸€è‡ªæ²»ç³»çµ±å…§éƒ¨äº¤æ›è·¯ç”±çš„å”å®šï¼ˆå¦‚ OSPFã€EIGRPï¼‰ã€‚                       |
| **EGP**ï¼ˆExterior Gateway Protocolï¼‰ | åœ¨è‡ªæ²»ç³»çµ±èˆ‡è‡ªæ²»ç³»çµ±ä¹‹é–“äº¤æ›è·¯ç”±çš„å”å®šï¼ˆå¦‚ BGPï¼‰ã€‚                         |
| **Anycast**                          | å¤šå€‹ç¯€é»å…±ç”¨åŒä¸€ IPï¼Œå°åŒ…æœƒè¢«å°å‘æœ€è¿‘çš„ç¯€é»ã€‚                              |
| **VGWï¼DXGW**                        | AWS çš„ç¶²é—œå…ƒä»¶ï¼Œæ‰®æ¼” BGP å°ç­‰ç«¯è§’è‰²ã€‚                                      |

---

## ğŸ“˜ æ¦‚å¿µè§£é‡‹

### ğŸ”„ BGP å¦‚ä½•äº¤æ›è·¯ç”±è³‡è¨Šï¼Ÿ

ç•¶å…©å€‹è‡ªæ²»ç³»çµ±ï¼ˆAutonomous Systemï¼‰æƒ³è¦äº¤æ›å½¼æ­¤çš„è·¯ç”±è³‡è¨Šæ™‚ï¼Œæœƒå…ˆå»ºç«‹ä¸€æ¢ BGP é€£ç·šï¼ˆBGP Sessionï¼‰ï¼Œé€™æ˜¯ä¸€ç¨®åŸºæ–¼ TCP port 179 çš„é•·é€£ç·šã€‚ä½ å¯èƒ½æœƒå•ï¼šç‚ºä»€éº¼æ˜¯ TCPï¼Ÿå› ç‚º BGP æ˜¯ä¸€ç¨®å¯é çš„ã€åŸºæ–¼ç‹€æ…‹çš„å”å®šï¼Œå®ƒéœ€è¦ç¢ºä¿æ¯å€‹ prefix çš„äº¤æ›ã€æ’¤éŠ·éƒ½èƒ½è¢«é›™æ–¹åŒæ­¥è¨˜éŒ„èˆ‡è¿½è¹¤ã€‚

Session å»ºç«‹å¾Œï¼Œå…¶ä¸­ä¸€æ–¹æœƒç”¨ UPDATE å°åŒ…ä¸»å‹•å®£å‘Šè‡ªå·±å¯ä»¥æŠµé”å“ªäº› prefixã€‚é€™äº›å®£å‘Šä¸åªåŒ…å«ç›®çš„ç¶²æ®µï¼Œé‚„é™„å¸¶å„ç¨®å±¬æ€§ï¼Œä¾‹å¦‚ï¼š

- **AS Path**ï¼šé€™æ®µè·¯å¾‘ç¶“éå“ªäº› ASï¼Œæ˜¯ loop é¿å…èˆ‡è·é›¢è¨ˆç®—çš„ä¾æ“šã€‚
- **Next Hop**ï¼šé€™æ¢è·¯çš„ä¸‹ä¸€è·³ IPï¼Œå¯¦éš›å°åŒ…è¦æ€éº¼é€å¾—å‡ºå»é å®ƒã€‚
- **Local Preference**ï¼šå…§éƒ¨åå¥½å€¼ï¼Œæ±ºå®šå“ªæ¢è·¯æ¯”è¼ƒè¢«åå¥½ã€‚
- **MEDï¼ˆMulti Exit Discriminatorï¼‰**ï¼šå»ºè­°å°æ–¹åå¥½å¾å“ªå€‹å‡ºå£é€²ä¾†ã€‚

é‚£é€™äº›è³‡è¨Šæ”¶åˆ°ä»¥å¾Œï¼Œå°æ–¹æœƒå…¨éƒ¨æ¥å—å—ï¼Ÿç•¶ç„¶ä¸æœƒã€‚æ¯ä¸€å° BGP router éƒ½æœƒæ ¹æ“šè‡ªå·±è¨­å®šçš„ routing policyï¼Œæ¯”è¼ƒæ‰€æœ‰å€™é¸è·¯å¾‘ï¼Œé¸å‡ºä¸€æ¢ best pathã€‚ä½ å¯ä»¥æƒ³åƒå®ƒåƒæ˜¯åœ¨æ¯”åƒ¹â€”â€”èª°çš„è·¯å¾‘æœ€çŸ­ã€å±¬æ€§æœ€å„ªï¼Œå°±é¸èª°ã€‚é¸å®šä¹‹å¾Œï¼Œé€™æ¢ best path æ‰æœƒè¢«å¯«å…¥æœ¬åœ°çš„è·¯ç”±è¡¨ä¸­ï¼ˆRIBï¼ŒRouting Information Baseï¼‰ï¼Œæˆç‚ºå¯¦éš›è½‰é€å°åŒ…æ‰€ä¾æ“šçš„ä¾æ“šã€‚

é€™å€‹æµç¨‹ä¸æ˜¯å–®æ¬¡çš„ï¼Œè€Œæ˜¯æŒçºŒé€²è¡Œçš„ã€‚åªè¦æœ‰ä¸€æ–¹æ’¤éŠ· prefixï¼ˆä¾‹å¦‚å…§éƒ¨è·¯ç”±æ”¹è®Šï¼‰ï¼Œæœƒå†æ¬¡é€å‡º UPDATE æˆ– WITHDRAWï¼Œå¦ä¸€æ–¹ä¹Ÿæœƒå³æ™‚æ›´æ–°è‡ªå·±çš„è·¯ç”±è¡¨ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘èªª BGP æ˜¯å‹•æ…‹è·¯ç”±å”å®šï¼Œè€Œä¸”æ˜¯ç¶²éš›ç¶²è·¯è·¯ç”±ç©©å®šæ€§çš„æ ¸å¿ƒã€‚

åœ¨ VPN æˆ–å…§éƒ¨ç¶²è·¯ä¸­ï¼Œä¹Ÿå¯ä»¥é€é `IGP` äº¤æ› private prefixï¼ˆåƒæ˜¯ `10.0.0.0/8`ï¼‰ï¼Œä½†é€™äº›ä¸æœƒè¢« propagate åˆ°å…¨çƒç¶²è·¯ï¼Œè€Œæ˜¯é™åˆ¶åœ¨ç‰¹å®š session é–“ä½¿ç”¨ã€‚

### ğŸ§­ BGP peering ä¸€å®šæ˜¯é›™å‘å—ï¼ŸAS å¯ä»¥è·Ÿä»»ä½•äººå»ºç«‹é€£ç·šå—ï¼Ÿ

ä½ å¯èƒ½æœƒæƒ³ï¼šã€Œæˆ‘æ—¢ç„¶æœ‰è‡ªå·±çš„ ASNï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥éš¨ä¾¿æ‰¾ä¸€å€‹ AS å»º BGP sessionï¼Ÿã€å¯¦éš›ä¸Šä¸¦ä¸è¡Œã€‚BGP æ˜¯å”å•†æ€§è³ªçš„å”å®šï¼Œä½ å¿…é ˆç²å¾—å°æ–¹ AS çš„å…è¨±ï¼Œé›™æ–¹æ‰èƒ½å»ºç«‹ peering é—œä¿‚ã€‚

é€™å°±åƒè¦é€²è¡Œäº¤æ˜“ï¼Œä½ å¿…é ˆå…ˆå–å¾—å°æ–¹åŒæ„ã€‚æ¯å€‹ AS éƒ½æœƒæ ¹æ“šè‡ªèº«ç­–ç•¥æ±ºå®šè¦ä¸è¦èˆ‡ä½ å°ç­‰ï¼Œåƒæ˜¯åœ°ç†ä½ç½®ã€æµé‡å¹³è¡¡ã€å•†æ¥­åˆ©ç›Šã€æŠ€è¡“æ¢ä»¶ç­‰éƒ½æ˜¯è€ƒé‡å› ç´ ï¼ˆæŠ€è¡“ä¸Šå‰‡æ˜¯æª¢æŸ¥ ip match / as match / tcp 179 port æ˜¯å¦æ”¾è¡Œç­‰ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¤§å‹ ISP é€šå¸¸ä¸èˆ‡å°å‹ä¼æ¥­ç›´æ¥ peeringï¼Œè€Œæ˜¯æä¾›ã€Œtransitã€æœå‹™ï¼Œç”±ä½ ä»˜è²»é€£ä¸Šä»–å€‘ï¼Œè®“ä»–å€‘å¹«ä½ ä¸­ç¹¼åˆ°æ›´å¤šç¶²è·¯ã€‚

æ‰€ä»¥å¦‚æœä½ æƒ³å¾ AS1 åˆ° AS3ï¼Œä½†ç„¡æ³•ç›´æ¥æ¥ä¸Šï¼Œä½ å¯èƒ½å¿…é ˆé€é AS2 ä¸­ç¹¼ï¼Œé€™å°±æ˜¯æˆ‘å€‘åœ¨ BGP ä¸­çœ‹åˆ°çš„ AS_PATH = 1 2 3ã€‚é€™æ®µè³‡è¨Šä¸åªæ˜¯ç¹è·¯ç´€éŒ„ï¼Œæ›´æ˜¯é¸è·¯ä¾æ“šèˆ‡é˜²æ­¢ loop çš„æ ¸å¿ƒè³‡æ–™ã€‚

é€™ä¹Ÿæ­£æ˜¯ç‚ºä»€éº¼ã€Œèª°è‚¯å¹«ä½ è½‰å‘Š prefix çµ¦èª°ã€é€™ä»¶äº‹éå¸¸é—œéµã€‚é€™å€‹ç­–ç•¥å«åš routing policyï¼Œè€Œä¸æ˜¯æ‰€æœ‰ prefix éƒ½èƒ½è¢« propagateã€‚ä½ å¯ä»¥è¦æ±‚ä¸­ç¹¼è€…ä¸è¦æŠŠä½ çš„å®£å‘Šå‚³å‡ºå»ï¼ˆå¦‚ no-exportï¼‰ï¼Œæˆ–è€…æŠŠæŸæ¢è·¯åš AS Path prependï¼Œè®“å®ƒã€Œçœ‹èµ·ä¾†æ¯”è¼ƒé ã€ï¼Œä»¥æ­¤é™ä½åˆ¥äººé¸ç”¨çš„æ©Ÿç‡ã€‚

### ğŸªœ ç‚ºä»€éº¼é‚„éœ€è¦ BGPï¼ŸIP å’Œ TCP ä¸å¤ å—ï¼Ÿ

IP è² è²¬ç‚ºæ¯å€‹å°åŒ…æŒ‡å®šç›®çš„åœ°ï¼ŒTCP å‰‡ç¢ºä¿å°åŒ…å¯é åœ°é€é”ï¼Œè€Œèª°ä¾†æ±ºå®šã€Œè·¯æ€éº¼èµ°ã€æ˜¯ BGP çš„è§’è‰²ã€‚ä½ å¯èƒ½æœƒæƒ³ï¼šã€Œé€™ä¸æ˜¯ route table åœ¨åšçš„äº‹å—ï¼Ÿã€æ²’éŒ¯ï¼Œä½† route table åªæ˜¯çµæœï¼Œè€Œä¸æ˜¯ç”¢ç”Ÿé€™äº›çµæœçš„æ©Ÿåˆ¶ã€‚BGP è² è²¬è®“ä¸åŒç¶²åŸŸä¹‹é–“äº’ç›¸äº¤æ›è·¯ç”±è³‡è¨Šï¼Œç”¢ç”Ÿä¸¦ç¶­æŒé€™äº›è·¯ç”±çš„æ­£ç¢ºæ€§èˆ‡ç©©å®šæ€§ã€‚æ²’æœ‰å®ƒï¼Œç¶²éš›ç¶²è·¯æ ¹æœ¬é€£ä¸åœ¨ä¸€èµ·ã€‚

### ğŸ” ç‚ºä»€éº¼ BGP æ˜¯ hop-by-hopï¼Ÿä¸æ˜¯ä¸€æ¬¡æ±ºå®šå¥½è·¯å¾‘ï¼Ÿ

ä¸€æ¢å°åŒ…çš„è·¯å¾‘ï¼Œæ˜¯ç”±æ¯ä¸€å€‹ä¸­ç¹¼è¨­å‚™è‡ªå·±æ±ºå®šã€Œä¸‹ä¸€è·³ã€ä¾†ç´¯ç©å®Œæˆçš„ã€‚æ¯å€‹ prefix å®£å‘Šä¸­æœƒé™„å¸¶ AS Pathï¼Œè®“æ¥æ”¶æ–¹èƒ½åˆ¤æ–·å°åŒ…æ˜¯å¦æœƒç¹å›è‡ªå·±ï¼ˆå³ loopï¼‰ï¼Œä¸€æ—¦ç™¼ç¾è‡ªå·±çš„ ASN å‡ºç¾åœ¨è·¯å¾‘ä¸­ï¼Œå°±æœƒæ‹’çµ•ä½¿ç”¨é€™æ¢è·¯å¾‘ã€‚é€™ç¨® hop-by-hop çš„æ±ºç­–æ–¹å¼è®“æ•´é«”ç³»çµ±å¯ä»¥åˆ†æ•£é‹ä½œï¼Œå…·å‚™é«˜åº¦å®¹éŒ¯æ€§ã€‚

### ğŸ  ç‚ºä»€éº¼æˆ‘åœ¨å®¶è£¡å¾ä¾†æ²’ç¢°é BGPï¼Ÿ

ä½ å¯èƒ½æœƒèªªï¼šã€Œæˆ‘å¾æ²’è¨­å®šéä»€éº¼ BGPï¼Œä½†ä¸Šç¶²ä¸æ˜¯ä¸€æ¨£é †ï¼Ÿã€å› ç‚ºä½ å®¶è£¡çš„è·¯ç”±å™¨åªéœ€è¦ä¸€æ¢ default route å°±èƒ½æŠŠæ‰€æœ‰å°åŒ…äº¤çµ¦ ISPã€‚æ¥ä¸‹ä¾†çš„æ‰€æœ‰è·¯ç”±é¸æ“‡ï¼Œéƒ½æ˜¯ç”± ISP èˆ‡å…¶ä»–è‡ªæ²»ç³»çµ±é€é BGP è‡ªå‹•å®Œæˆçš„ã€‚ç°¡å–®ä¾†èªªï¼Œä½ æ˜¯ç¶²è·¯çš„çµ‚é»ï¼Œè€Œä¸æ˜¯ routing çš„åƒèˆ‡è€…ã€‚åªæœ‰ç•¶ä½ éœ€è¦è·¨ç«™é»é€£ç·šï¼ˆä¾‹å¦‚ä¼æ¥­ç¸½éƒ¨èˆ‡åˆ†éƒ¨ï¼‰ã€è‡ªå»º WANã€æˆ–æ¥å…¥é›²ç«¯æ™‚ï¼Œä½ æ‰æœƒæˆç‚º BGP çš„ä¸€ä»½å­ã€‚é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼åœ¨ AWS ä¸Šä½ æœƒé–‹å§‹é‡åˆ° BGPâ€”â€”é‚£ä»£è¡¨ä½ æ­£åœ¨åƒèˆ‡ã€Œç¶²è·¯çš„é‚Šç•Œã€ã€‚

### ğŸ§­ ç‚ºä»€éº¼ BGP åªè² è²¬ AS ä¹‹é–“ï¼Ÿé‚£ AS å…§éƒ¨æ€éº¼åšï¼Ÿ

BGP è² è²¬çš„æ˜¯è‡ªæ²»ç³»çµ±ä¹‹é–“çš„è³‡è¨Šäº¤æ›ï¼ˆç¨±ç‚º eBGPï¼‰ï¼Œä½†åœ¨ä¸€å€‹ AS å…§éƒ¨ï¼Œè‹¥æœ‰æ•¸åå°ç”šè‡³ä¸Šç™¾å°è·¯ç”±å™¨ï¼Œé›£é“ä¹Ÿè¦æ‰‹å‹•å¯«éœæ…‹è·¯ç”±ï¼Ÿç•¶ç„¶ä¸æ˜¯ã€‚é€™æ™‚å€™ï¼Œå°±æœƒç”± IGPï¼ˆå¦‚ OSPFã€EIGRPï¼‰æ¥æ‰‹ï¼Œè®“å…§éƒ¨è¨­å‚™å½¼æ­¤äº¤æ›è·¯ç”±è³‡è¨Šï¼Œè‡ªå‹•ç¶­æŒå…§éƒ¨æ‹“æ’²ã€‚é€™æ¨£ BGP å°±å¯ä»¥åªå°ˆæ³¨åœ¨ã€Œå‘Šè¨´å…¶ä»– ASï¼šæˆ‘æœ‰å“ªäº› prefix å¯ä»¥æä¾›ã€ï¼Œè€Œä¸æ˜¯è™•ç†å…§éƒ¨ç´°ç¯€ã€‚

### ğŸŒ Anycast æ˜¯ä»€éº¼ï¼Ÿå®ƒè·Ÿ BGP æœ‰ä»€éº¼é—œä¿‚ï¼Ÿ

ä½ å¯èƒ½è½é DNS æœ‰ä¸€å€‹å…¨çƒå…±ç”¨çš„ IPï¼ˆåƒæ˜¯ 8.8.8.8ï¼‰ï¼Œå»èƒ½é€£åˆ°ä¸åŒçš„åœ°é»ï¼Œé€™æ˜¯æ€éº¼åšåˆ°çš„ï¼Ÿç­”æ¡ˆå°±æ˜¯ Anycastã€‚Anycast æ˜¯ä¸€ç¨®å»ºæ§‹åœ¨ BGP ä¸Šçš„æ‡‰ç”¨ç­–ç•¥ï¼Œè®“å¤šå€‹åœ°ç†ä½ç½®çš„ç¯€é»åŒæ™‚å°å¤–å®£å‘Šç›¸åŒçš„ IP prefixï¼Œè®“å°åŒ…è¢«å°å‘ã€Œæ‹“æ’²ä¸Šæœ€è¿‘çš„ç¯€é»ã€ã€‚

é€™è£¡çš„ã€Œæœ€è¿‘ã€ä¸æ˜¯æŒ‡ç‰©ç†è·é›¢ï¼Œè€Œæ˜¯ BGP èªç‚ºçš„è·¯ç”±æˆæœ¬æœ€çŸ­ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä¸åŒåœ°å€çš„ä½¿ç”¨è€…æœƒé€éä¸åŒçš„è·¯å¾‘ï¼Œè¢« BGP è‡ªå‹•å°å‘é›¢ä»–å€‘æœ€è¿‘çš„ Anycast ç¯€é»ï¼Œè€Œé€™ä¸€åˆ‡æ˜¯ç”± BGP çš„é¸è·¯æ©Ÿåˆ¶æ‰€é©…å‹•ã€‚

Anycast å¯ä»¥è®“å…¨çƒä½¿ç”¨è€…éƒ½ç”¨åŒä¸€ IPï¼Œè€Œä¸éœ€è¦è¨­è¨ˆ DNS å°æ‡‰é‚è¼¯ï¼ŒåŒæ™‚å…·å‚™ï¼š

- å¿«é€Ÿæ¥å…¥ï¼šå°åŒ…å°±è¿‘é€é”ï¼Œæé«˜å»¶é²è¡¨ç¾ã€‚
- è‡ªå‹•å®¹éŒ¯ï¼šç¯€é»ä¸‹ç·šæ™‚ï¼ŒBGP è‡ªå‹•æŠŠæµé‡è½‰å‘å…¶ä»–ç¯€é»ã€‚
- å¤§é‡åˆ†æµï¼šDDoS æ”»æ“Šå¯ä»¥åˆ†æ•£é€²å¤šå€‹ç¯€é»ï¼Œè€Œä¸æ˜¯çŒçˆ†å–®é»ã€‚
  > å°±åƒæ˜¯ Google Map çš„ã€Œæœ‰æ›´å¿«è·¯ç·šå¯ä¾›é¸æ“‡ã€ã€‚

å¸¸è¦‹æ‡‰ç”¨åŒ…å« Google DNSï¼ˆ8.8.8.8ï¼‰ã€Cloudflare CDNã€L-rootã€AWS Global Accelerator ç­‰ã€‚ä½ å¯èƒ½æœƒå•ï¼šã€Œé€™æ¨£å°åŒ…å›ç¨‹æœƒä¸æœƒèµ°å¦ä¸€æ¢è·¯ï¼Ÿã€æ˜¯çš„ï¼ŒAnycast æ˜¯éå°ç¨±è·¯ç”±æ¨¡å‹ï¼Œè«‹æ±‚èˆ‡å›æ‡‰å¯èƒ½ç¶“éä¸åŒç¯€é»ï¼Œé€™åœ¨è¨ºæ–·æ™‚è¦ç‰¹åˆ¥æ³¨æ„ã€‚

---

## ğŸ› ï¸ AWS é™¤éŒ¯ SOP

ä»¥ä¸‹æ˜¯ä¸€å€‹ç³»çµ±æ€§çš„æ’æŸ¥æµç¨‹ï¼Œç•¶ä½ åœ¨ AWS æ¶æ§‹ä¸‹ï¼ˆä¾‹å¦‚ Site-to-Site VPNã€Direct Connectï¼‰é‡åˆ°ç„¡æ³•å¾ on-prem åˆ° VPCã€æˆ–æ˜¯ BGP æ²’å­¸åˆ° prefix çš„å•é¡Œæ™‚ï¼Œå¯ä»¥ä¾ç…§é€™å€‹é †åºæ’æŸ¥ã€‚

### ğŸ” æ­¥é©Ÿä¸€ï¼šç¢ºèª BGP Session æ˜¯å¦å»ºç«‹æˆåŠŸ

- **åœ¨å“ªè£¡çœ‹ï¼Ÿ** åœ¨ on-prem router æˆ–é˜²ç«ç‰†çš„ä»‹é¢ï¼ˆå¦‚ FortiGateã€Ciscoã€VyOSï¼‰ä¸Šã€‚
- **æŒ‡æ¨™è¨Šè™Ÿï¼š** BGP session æœ‰ `Established` ç‹€æ…‹ã€‚
- **å¸¸è¦‹éŒ¯èª¤ï¼š** IP ä¸é€šã€TCP port 179 è¢«æ“‹ã€ASN è¨­å®šéŒ¯ã€å°ç­‰ç«¯æœªä¸Šç·šã€‚

### ğŸ” æ­¥é©ŸäºŒï¼šé›™æ–¹æ˜¯å¦æ­£ç¢ºå®£å‘Š prefixï¼Ÿ

- **åœ¨å“ªè£¡çœ‹ï¼Ÿ**

  - On-prem æª¢æŸ¥ï¼š`show ip bgp` çœ‹ AWS å®£å‘Šäº†å“ªäº› prefixã€‚
  - AWS ç«¯æª¢æŸ¥ï¼šè§€å¯Ÿ VPC route table æ˜¯å¦æœ‰è‡ªå‹•å‡ºç¾ on-prem çš„ routeã€‚

- **è§€å¯Ÿé‡é»ï¼š** Prefix æ˜¯å¦åœ¨æœŸæœ›ç¯„åœå…§ï¼Ÿæ˜¯ /16 é‚„æ˜¯å¤ªå°è¢«éæ¿¾æ‰ï¼Ÿï¼ˆAWS å° prefix æœ€å°é•·åº¦æœ‰é™åˆ¶ï¼‰

ä½ å¯èƒ½æœƒå¿½ç•¥ï¼šå®£å‘Š private prefix æ²’å•é¡Œï¼Œä½†å¦‚æœä½ éŒ¯ç”¨ public ASN å®£å‘Š private prefixï¼Œå°æ–¹æœ‰å¯èƒ½éæ¿¾æ‰ã€‚

### ğŸ” æ­¥é©Ÿä¸‰ï¼šRoute Table æœ‰æ­£ç¢ºæ¥æ”¶ Propagation å—ï¼Ÿ

- **è§€å¯Ÿ VPC Route Tableï¼š** æ˜¯å¦æœ‰é€£åˆ° VGW çš„ routeï¼Ÿæ˜¯å¦æ‰“é–‹äº† propagationï¼Ÿ
- **åå‘ä¹Ÿè¦æª¢æŸ¥ï¼š** on-prem æ˜¯å¦æœ‰å¾ BGP å­¸åˆ°å› AWS çš„ prefixï¼Œå¦å‰‡å°åŒ…å‡ºå¾—å»ï¼Œå›ä¸ä¾†ã€‚

ä½ å¯èƒ½æœƒå•ï¼šã€ŒAWS ä¸Šçš„ propagation æ˜¯ä¸æ˜¯è‡ªå‹•çš„ï¼Ÿã€æ˜¯çš„ï¼Œä½†å‰ææ˜¯ä½ æœ‰å•Ÿç”¨ propagation æ¬Šé™ï¼Œä¸”å°æ‡‰çš„ VGW èˆ‡ VPN Connection è¨­å®šæ­£ç¢ºã€‚

### ğŸ” æ­¥é©Ÿå››ï¼šå°åŒ…çœŸçš„å‡ºå¾—å»ã€å›å¾—ä¾†å—ï¼Ÿ

- **VPC Flow Logs** æ˜¯ä½ æœ€å¥½çš„æœ‹å‹ã€‚ä½ å¯ä»¥è§€å¯Ÿå°åŒ…æ˜¯å¦çœŸçš„é€å‡ºäº†ã€æ˜¯å¦æœ‰ ACK å›ä¾†ã€‚
- **Security Group èˆ‡ NACL** é›–ç„¶ä¸æ˜¯ routing çš„ä¸€éƒ¨åˆ†ï¼Œä½†æœƒå½±éŸ¿å°åŒ…æ˜¯å¦èƒ½è¢«æ¥å—ã€‚

å¦‚æœä½ çœ‹åˆ°å°åŒ…å¾ EC2 å‡ºå»äº†ï¼Œä½†æ²’æœ‰å›ä¾†ï¼Œé‚£å¯èƒ½æ˜¯ on-prem æ²’æœ‰ routeã€æ²’å®£å‘Šã€æ²’ NATã€æˆ–é˜²ç«ç‰†æ“‹ä½äº†ã€‚

### ğŸ“Œ å°çµ

| æª¢æŸ¥é …ç›®                          | æª¢æŸ¥é»            | å·¥å…·æˆ–æŒ‡ä»¤                                            |
| --------------------------------- | ----------------- | ----------------------------------------------------- |
| BGP Session æ˜¯å¦æˆç«‹              | VPN å°ç­‰ç«¯        | `show ip bgp summary` æˆ– CloudWatch VPN Tunnel Metric |
| Prefix æ˜¯å¦æœ‰äº¤æ›æˆåŠŸ             | é›™æ–¹è·¯ç”±è¡¨        | `show ip bgp`ã€VPC route table                        |
| Route table æ˜¯å¦ propagation æ­£ç¢º | AWS VPC           | Route table é é¢ + propagation status                 |
| å°åŒ…æ˜¯å¦èµ°å¾—å‡ºå»å›å¾—ä¾†            | Flow Logsï¼æŠ“å°åŒ… | Flow logsã€EC2 logã€Firewall log                      |

é€™å€‹æµç¨‹çš„ç›®çš„ä¸æ˜¯è¦ä½ è¨˜ä½æ‰€æœ‰è¨­å®šï¼Œè€Œæ˜¯è¨“ç·´ä½ å…·å‚™ä¸€å€‹ mental modelï¼šBGP æ˜¯å»ºç«‹è³‡è¨Šï¼ŒRoute Table æ˜¯è½‰é€ä¾æ“šï¼Œå°åŒ…æ˜¯å¦å¯é”æ˜¯æœ€çµ‚é©—è­‰ã€‚

---

## ğŸ§  å»¶ä¼¸ï¼šç¶“ç‡Ÿè‡ªæ²»ç³»çµ±çš„å•†æ¥­æ¨¡å¼

è‡ªæ²»ç³»çµ±ï¼ˆASï¼‰é€šå¸¸æ˜¯ç”± ISPã€é›²ç«¯ã€CDNã€ç¶²å®‰æ¥­è€…ç­‰è§’è‰²ç¶“ç‡Ÿã€‚è¦ç‡Ÿé‹ä¸€å€‹è‡ªæ²»ç³»çµ±ï¼Œä½ å¿…é ˆå…·å‚™ï¼š

1. **åˆæ³•çš„ ASN**ï¼šå‘å€åŸŸç¶²è·¯è¨»å†Šç®¡ç†æ©Ÿæ§‹ï¼ˆRIRï¼‰å¦‚ APNICã€ARIN ç”³è«‹ã€‚
2. **è‡ªæœ‰æˆ–å–å¾—çš„ IP ç©ºé–“**ï¼šå¯ä»¥æ˜¯ IPv4 æˆ– IPv6ï¼Œå¤šç‚º public prefixã€‚
3. **ä¸Šæ¸¸ï¼ˆupstreamï¼‰é€£ç·šå¤¥ä¼´**ï¼šèˆ‡ ISP æˆ– IXï¼ˆInternet Exchangeï¼‰å»ºç«‹ BGP peeringã€‚
4. **è·¯ç”±æ§ç®¡èˆ‡ç›£æ§èƒ½åŠ›**ï¼šé…ç½® BGP policyã€route filterã€é˜²æ­¢ prefix leakã€è¨­å®š RPKI ç­‰ã€‚

### ğŸ’¡ å¸¸è¦‹ç‡Ÿé‹æƒ…å¢ƒ

| é¡å‹          | è§’è‰²èˆ‡è¡Œç‚º                                          |
| ------------- | --------------------------------------------------- |
| ISPï¼é›»ä¿¡å•†   | å®£å‘Šå¤§é‡å®¢æˆ¶çš„ prefixï¼Œæ¥æ”¶æ•¸ç™¾æ¢ peeringã€‚         |
| è·¨åœ‹ä¼æ¥­      | æ§åˆ¶ä¼æ¥­ WANï¼VPNï¼Œä½¿ç”¨å¤šå€‹ DXï¼ISPã€åšæµé‡æœ€é©åŒ–ã€‚ |
| CDNï¼é›²ç«¯å¹³å° | é€é Anycast + BGP æä¾›å…¨çƒä½å»¶é²æ¥å…¥é»ã€‚           |
| DDoS é˜²ç¦¦å•†   | ä½¿ç”¨ BGP diversion æŠ€è¡“å°‡æµé‡å°å‘æ¸…æ´—ä¸­å¿ƒã€‚         |
| æ•™è‚²ç ”ç©¶å–®ä½  | åƒèˆ‡å­¸è¡“ IXï¼ˆå¦‚ TWARENï¼‰ã€å…±äº«è·¯ç”±è³‡æºã€‚            |

---

### ğŸ’° å¦‚ä½•é€éè‡ªæ²»ç³»çµ±ç²åˆ©ï¼Ÿ

1. **è²©å”®é »å¯¬èˆ‡ transit**ï¼šä½ å¯ä»¥æˆç‚ºå…¶ä»–å°å‹ AS çš„ä¸Šæ¸¸ã€‚
2. **æä¾› DDoS ç·©è§£ï¼æµé‡æ¸…æ´—æœå‹™**ï¼šçµåˆ BGP diversion èˆ‡æ¸…æ´—è¨­å‚™ã€‚
3. **æˆç‚º CDN ç¯€é»æˆ–é›²æœå‹™è½‰é‹é»**ï¼šèˆ‡å…§å®¹å¹³å°åˆä½œï¼Œæä¾›åœ°å€æ€§å¿«å–ã€‚
4. **ç®¡ç†è¤‡æ•¸ BGP å‡ºå£åšæˆæœ¬å„ªåŒ–**ï¼šé€é routing policy å°‡éé—œéµæµé‡å°å‡ºå»‰åƒ¹è·¯ã€‚

> åœ¨é€™å€‹ä»¥æ‡‰ç”¨ç‚ºæ ¸å¿ƒçš„æ™‚ä»£ï¼Œæ§åˆ¶åº•å±¤å°åŒ…çš„é€²å‡ºå£ï¼Œä»æ˜¯ä¸€ç¨®æ¥µé«˜çš„æŠ€è¡“å„ªå‹¢èˆ‡è«‡åˆ¤ç±Œç¢¼ã€‚

---

# ğŸ§ª Hands-on Lab

## ğŸ” ç”¨ FRR æ¨¡æ“¬å…©å€‹ AS é€é BGP äº¤æ›è·¯ç”±

FRRï¼ˆFree Range Routingï¼‰æ˜¯ä¸€å¥—é–‹æºçš„å‹•æ…‹è·¯ç”±å”å®šå¥—ä»¶ï¼Œæ”¯æ´åŒ…æ‹¬ BGPã€OSPFã€RIPã€IS-IS ç­‰å”å®šï¼Œå»£æ³›ç”¨æ–¼ Linux router æ¨¡æ“¬èˆ‡ç¶²è·¯å¯¦é©—ä¸­ã€‚

å®ƒçš„æ¶æ§‹æ¡ç”¨æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œä¸»è¦å…ƒä»¶åŒ…æ‹¬ï¼š

- `zebra`ï¼šFRR çš„æ ¸å¿ƒå®ˆè­·ç¨‹åºï¼Œç®¡ç† routing table èˆ‡ interface ç‹€æ…‹ï¼Œå…¶ä»– daemon éƒ½é€éå®ƒèˆ‡ kernel äº’å‹•ã€‚
- `bgpd`ï¼šè² è²¬ BGP å”å®šçš„å¯¦ä½œèˆ‡é‹ä½œã€‚
- `vtysh`ï¼šäº’å‹•å¼ shellï¼Œæä¾›çµ±ä¸€ CLI ä»‹é¢ï¼Œå¯åŒæ™‚å­˜å–æ‰€æœ‰ daemonï¼ˆä¾‹å¦‚ bgpdã€zebraï¼‰ã€‚

### æ“ä½œ

1. `$ docker compose up`
1. `$ docker exec -it router1 vtysh`
1. `$ show ip bgp summary`

   ```
   IPv4 Unicast Summary (VRF default):
   BGP router identifier 1.1.1.1, local AS number 65001 vrf-id 0
   BGP table version 2
   RIB entries 3, using 576 bytes of memory
   Peers 1, using 717 KiB of memory

   Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
   172.31.253.9    4      65002        11        12        0    0    0 00:00:02            1        2 N/A

   Total number of neighbors 1
   ```

   - **Neighbor**ï¼šå°ç­‰ç«¯ IP
   - **V**ï¼šBGP å”å®šç‰ˆæœ¬ï¼ˆé€šå¸¸ç‚º 4ï¼‰
   - **AS**ï¼šå°ç­‰ç«¯çš„ Autonomous System Number
   - **MsgRcvd / MsgSent**ï¼šå¾å°ç­‰ç«¯æ¥æ”¶èˆ‡é€å‡ºçš„ BGP è¨Šæ¯æ•¸é‡
   - **TblVer**ï¼šæœ¬åœ° RIBï¼ˆRouting Information Baseï¼‰çš„ç‰ˆæœ¬è™Ÿ
   - **InQ / OutQ**ï¼šå°šæœªè™•ç†çš„ BGP å°åŒ…æ•¸ï¼ˆæ­£å¸¸ç‚º 0ï¼‰
   - **Up/Down**ï¼šBGP session ç¶­æŒçš„æ™‚é–“ï¼Œè‹¥ä¸ç‚º 0 è¡¨ç¤ºå·²å»ºç«‹
   - **State/PfxRcd**ï¼šè‹¥ç‚º `Established`ï¼Œæ­¤æ¬„æœƒé¡¯ç¤ºå­¸åˆ°çš„ prefix æ•¸ï¼›è‹¥ç‚º `(Policy)` è¡¨ç¤ºæœ‰ prefix è¢« policy æ“‹ä¸‹
   - **PfxSnt**ï¼šæœ¬æ©Ÿé€å‡ºçµ¦è©² neighbor çš„ prefix æ•¸
   - **Desc**ï¼šå‚™è¨»ï¼Œå¯è‡ªå®šç¾©

1. `$ show ip bgp`

   ```
   BGP table version is 2, local router ID is 1.1.1.1, vrf id 0
   Default local pref 100, local AS 65001
   Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
                 i internal, r RIB-failure, S Stale, R Removed
   Nexthop codes: @NNN nexthop's vrf id, < announce-nh-self
   Origin codes:  i - IGP, e - EGP, ? - incomplete
   RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
   *> 10.10.10.0/24    0.0.0.0                  0         32768 i
   *> 20.20.20.0/24    172.31.253.9             0             0 65002 i

   Displayed  2 routes and 2 total paths
   ```

   å¯ä»¥çœ‹åˆ°é™¤äº† prefix `20.20.20.0/24` å·²ç¶“æŒ‡å‘ router2ã€‚
